@using DMS_Final.Models
@{
    var allTags = ViewBag.AllTags as List<TagModel>;
    var selectedTags = ViewBag.SelectedTags as List<DocumentTagModel>;
    var selectedTagNames = selectedTags?.Select(t => t.TagName).ToHashSet() ?? new HashSet<string>();
    var tagOptionsHtml = string.Join("", allTags.Select(t =>
        selectedTagNames.Contains(t.Name)
            ? $"<option value=\"{t.Id}\" selected>{t.Name}</option>"
            : $"<option value=\"{t.Id}\">{t.Name}</option>"
    ));
    var tagOptionsHtmlNoSelect = string.Join("", allTags.Select(t =>
        $"<option value=\"{t.Id}\">{t.Name}</option>"
    ));
}
<h2>Upload New Version</h2>

<form asp-action="UploadNewVersion" asp-controller="Document" method="post" enctype="multipart/form-data">
    <input type="hidden" name="documentDetailId" value="@ViewBag.DocumentDetailId" />
    <input type="hidden" name="documentId" value="@ViewBag.DocumentId" />

    <hr />

    <div id="fileFields">
        <div class="file-group mb-2">
            <label>File</label>
            <input type="file" name="Files" class="form-control" required />

            <label>File Description</label>
            <input type="text" name="FileDescriptions" class="form-control"
                   value="@ViewBag.FileDescription" />

            <label>Tags</label>
            <select name="TagIds[0]" class="form-control tag-select" multiple="multiple" style="width: 100%;">
                @Html.Raw(tagOptionsHtml)
            </select>

            <button type="button" class="btn btn-danger btn-sm remove-btn" style="display:none;" onclick="removeField(this)">-</button>
        </div>
    </div>

    <button type="button" class="btn btn-primary btn-sm mb-3" onclick="addField()">Add More Files</button>
    <br />
    <button type="submit" class="btn btn-success">Upload</button>
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script>
        let fileIndex = 1;
        function addField() {
            const container = document.getElementById('fileFields');
            const group = document.createElement('div');
            group.className = 'file-group mb-2';
            group.innerHTML = `
                <label>File</label>
                <input type="file" name="Files" class="form-control" required />

                <label>File Description</label>
                <input type="text" name="FileDescriptions" class="form-control" />

                <label>Tags</label>
                <select name="TagIds[${fileIndex}]" class="form-control tag-select" multiple="multiple" style="width: 100%;">
                    @Html.Raw(tagOptionsHtmlNoSelect)
                </select>

                <button type="button" class="btn btn-danger btn-sm remove-btn" onclick="removeField(this)">-</button>
            `;
            container.appendChild(group);
            $(group).find('.tag-select').select2({
                placeholder: "Select tags",
                allowClear: true
            });
            fileIndex++;
        }

        function removeField(btn) {
            btn.parentElement.remove();
        }

        $(document).ready(function () {
            $('.tag-select').select2({
                placeholder: "Select tags",
                allowClear: true
            });
        });
    </script>
}