@model DMS.Models.DocumentModel

@{
    ViewData["Title"] = "New Version";
}

<h3 class="text-center mb-2">Add New Version to: @ViewBag.DocumentTitle</h3>
<p class="text-center text-muted small mb-3">Next Version: <strong>@ViewBag.NextVersion</strong></p>

<form asp-action="AddNewDocumentVersion" method="post" enctype="multipart/form-data" id="uploadForm">
    <input type="hidden" name="documentId" value="@ViewBag.DocumentId" />
    <input type="hidden" name="Title" value="@ViewBag.DocumentTitle" />

    <div id="fileContainer">
        <div class="file-group border p-3 mb-3 rounded shadow-sm">
            <h6 class="fw-bold">File 1</h6>
            <div class="mb-2">
                <label class="form-label small">Select File</label>
                <input type="file"
                       name="Files"
                       class="form-control form-control-sm file-input"
                       accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
                       required />
            </div>
            <div class="mb-2">
                <label class="form-label small">Description</label>
                <textarea name="FileDescriptions" class="form-control form-control-sm" rows="1" required></textarea>
            </div>
            <div class="mb-2">
                <label class="form-label small">Tags</label>
                <select name="TagIds[0]" class="form-select form-select-sm tag-select" multiple="multiple" style="width:100%">
                    @foreach (var tag in ViewBag.AllTags)
                    {
                        <option value="@tag.Id">@tag.Name</option>
                    }
                </select>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-secondary btn-sm" onclick="addFileInput()">
            <i class="bi bi-plus-circle me-1"></i> Add Another File
        </button>
        <div>
            <a asp-action="EditDocument" asp-route-documentId="@ViewBag.DocumentId" class="btn btn-danger btn-sm">
                <i class="bi bi-x-circle me-1" aria-hidden="true"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-upload me-1"></i> Upload Version
            </button>
        </div>
    </div>
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">

    <script>
        let fileCount = 1;

        // Allowed file extensions
        const allowedExtensions = [
            "jpg", "jpeg", "png", "gif",
            "pdf", "doc", "docx", "xls", "xlsx",
            "ppt", "pptx"
        ];

        function validateFileInput(fileInput) {
            const files = fileInput.files;
            for (let file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(ext)) {
                    alert(`❌ File type not allowed: ${file.name}\nAllowed types: ${allowedExtensions.join(', ')}`);
                    fileInput.value = ''; // Clear invalid file
                    return false;
                }
            }
            return true;
        }

        // Add dynamic file input group
        function addFileInput() {
            fileCount++;
            const container = document.getElementById('fileContainer');
            const div = document.createElement('div');
            div.className = 'file-group border p-3 mb-3 rounded shadow-sm';
            div.innerHTML = `
                <h6 class="fw-bold">File ${fileCount}</h6>
                <div class="mb-2">
                    <label class="form-label small">Select File</label>
                    <input type="file"
                           name="Files"
                           class="form-control form-control-sm file-input"
                           accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
                           required />
                </div>
                <div class="mb-2">
                    <label class="form-label small">Description</label>
                    <textarea name="FileDescriptions" class="form-control form-control-sm" rows="1" required></textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Tags</label>
                    <select name="TagIds[${fileCount - 1}]" class="form-select form-select-sm tag-select" multiple="multiple" style="width:100%">
                        @foreach (var tag in ViewBag.AllTags)
                        {
                                <option value="@tag.Id">@tag.Name</option>
                        }
                    </select>
                </div>
                <button type="button" class="btn btn-danger btn-sm mt-1" onclick="this.closest('.file-group').remove()">
                    <i class="bi bi-trash"></i> Remove
                </button>
            `;
            container.appendChild(div);

            $(div).find('.tag-select').select2({
                placeholder: "Select tags",
                allowClear: true,
                dropdownCssClass: "form-select-sm"
            });

            // Attach validation
            $(div).find('.file-input').on('change', function () {
                validateFileInput(this);
            });
        }

        $(document).ready(function () {
            $('.tag-select').select2({
                placeholder: "Select tags",
                allowClear: true,
                dropdownCssClass: "form-select-sm"
            });

            // Attach validation to existing file input
            $('.file-input').on('change', function () {
                validateFileInput(this);
            });
        });
    </script>
}
