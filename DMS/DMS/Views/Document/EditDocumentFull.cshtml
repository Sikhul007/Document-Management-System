@model List<DMS.Models.DocumentDetailsModel>
@using DMS.Models
@{
    var document = ViewBag.Document as DocumentModel;
    var allTags = ViewBag.AllTags as List<TagModel>;
}

<h4 class="mb-3">Edit Document</h4>
<form asp-action="SaveDocumentEdits" asp-controller="Document" method="post" enctype="multipart/form-data" style="font-size: 0.9rem;" onsubmit="return validateFiles()">
    <input type="hidden" name="DocumentId" value="@document?.Id" />

    <div class="mb-2">
        <label class="form-label fw-semibold">Title</label>
        <input type="text" name="Title" value="@document?.Title" class="form-control form-control-sm" required />
    </div>

    <div class="mb-2">
        <label class="form-label fw-semibold">Description</label>
        <textarea name="Description" class="form-control form-control-sm" rows="2" required>@document?.Description</textarea>
    </div>

    <hr class="my-3" />
    <h6 class="fw-semibold mb-2">Files</h6>

    @for (int i = 0; i < Model.Count; i++)
    {
        var file = Model[i];
        <div class="border rounded p-2 mb-2" style="font-size: 0.9rem;">
            <input type="hidden" name="FileIds" value="@file.Id" />

            <div class="mb-1 d-flex justify-content-between align-items-center">
                <div>
                    <label class="form-label mb-0">
                        <span style="display:inline-block; max-width:700px; word-break:break-all; white-space:normal;">
                            File Name: <b>@file.OriginalFileName</b>
                        </span>
                    </label>
                </div>
                <div class="d-flex gap-1">
                    <a asp-action="ViewDocument" asp-route-documentDetailId="@file.Id" class="btn btn-info btn-sm" target="_blank" title="View Document">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a asp-action="DownloadDocument" asp-route-documentDetailId="@file.Id" class="btn btn-success btn-sm" title="Download Document">
                        <i class="bi bi-cloud-arrow-down-fill"></i>
                    </a>
                </div>
            </div>

            <div class="mb-1">
                <label class="form-label fw-semibold mb-1">Description</label>
                <input type="text" name="FileDescriptions" value="@file.Description" class="form-control form-control-sm" />
            </div>

            <div class="mb-1">
                <label class="form-label fw-semibold mb-1">Tags</label>
                <select name="TagIds[@i]" class="form-control form-control-sm tag-select" multiple="multiple" style="width: 100%;">
                    @foreach (var tag in allTags)
                    {
                        if (file.Tags.Contains(tag.Name))
                        {
                            <option value="@tag.Id" selected>@tag.Name</option>
                        }
                        else
                        {
                            <option value="@tag.Id">@tag.Name</option>
                        }
                    }
                </select>
            </div>

            <div class="mb-1">
                <label class="form-label fw-semibold mb-1">Upload New Version(s)</label>
                <input type="file" name="NewFiles[@i]" multiple class="form-control form-control-sm file-input"
                       accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx" />
                <small class="text-muted">Allowed: JPG, PNG, PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX</small>
            </div>
        </div>
    }

    <button type="submit" class="btn btn-success btn-sm mt-2 px-3">Save Changes</button>
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <script>
        const allowedExtensions = [".jpg", ".jpeg", ".png", ".pdf", ".doc", ".docx", ".xls", ".xlsx", ".ppt", ".pptx"];

        // Initialize Select2
        $(document).ready(function () {
            $('.tag-select').select2({
                placeholder: "Select tags",
                allowClear: true,
                width: '100%'
            });
        });

        // File type validation before submitting
        function validateFiles() {
            const fileInputs = document.querySelectorAll('.file-input');
            for (let input of fileInputs) {
                if (input.files.length > 0) {
                    for (let file of input.files) {
                        const fileName = file.name.toLowerCase();
                        const isValid = allowedExtensions.some(ext => fileName.endsWith(ext));
                        if (!isValid) {
                            alert("❌ Invalid file type: " + fileName +
                                  "\n\nAllowed types: " + allowedExtensions.join(", "));
                            input.value = ""; // clear invalid selection
                            return false; // stop form submission
                        }
                    }
                }
            }
            return true;
        }
    </script>
}
